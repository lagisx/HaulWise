<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Маршрут</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    let myMap;
    let multiRoute = null;
    let placemarks = [];

    ymaps.ready(() => {
        myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 4,
            controls: ['zoomControl', 'fullscreenControl']
        });

        myMap.behaviors.disable('drag');
        setTimeout(() => myMap.behaviors.enable('drag'), 300);
    });

    function clearMap() {
        if (multiRoute) {
            myMap.geoObjects.remove(multiRoute);
            multiRoute = null;
        }
        placemarks.forEach(p => myMap.geoObjects.remove(p));
        placemarks = [];
    }

    window.showRoute = function(coords, fromCity, toCity) {
        if (!myMap || !coords || coords.length < 2) return;

        clearMap();

        const start = [coords[0][1], coords[0][0]];  // [lat, lon]
        const end   = [coords[coords.length-1][1], coords[coords.length-1][0]];

        // САМЫЙ НАДЁЖНЫЙ СПОСОБ — создаём маршрут и ждём готовности
        multiRoute = new ymaps.multiRouter.MultiRoute({
            referencePoints: [start, end],
            params: { routingMode: 'auto' }
        }, {
            routeActiveStrokeWidth: 10,
            routeActiveStrokeColor: "#0066FF",
            routeStrokeWidth: 6,
            routeStrokeColor: "#3388FF",
            boundsAutoApply: false  // ВЫКЛЮЧАЕМ авто-зум здесь
        });

        // Добавляем на карту
        myMap.geoObjects.add(multiRoute);

        // Метки
        const startPm = new ymaps.Placemark(start, {
            balloonContent: `<strong style="color:#0066FF">Откуда:</strong><br><big>${fromCity}</big>`
        }, { preset: 'islands#blueStretchyIcon' });

        const endPm = new ymaps.Placemark(end, {
            balloonContent: `<strong style="color:#FF3300">Куда:</strong><br><big>${toCity}</big>`
        }, { preset: 'islands#redStretchyIcon' });

        myMap.geoObjects.add(startPm);
        myMap.geoObjects.add(endPm);
        placemarks = [startPm, endPm];

        // ГЛАВНОЕ: ждём, когда маршрут построится
        multiRoute.getRoutes().events.add('ready', () => {
            // Теперь точно есть линия — делаем зум
            const bounds = multiRoute.getBounds();
            if (bounds) {
                myMap.setBounds(bounds, {
                    checkZoomRange: true,
                    zoomMargin: 50,
                    duration: 800
                });
            }
        });
    };
</script>
</body>
</html>